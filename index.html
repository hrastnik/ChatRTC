<!DOCTYPE htlm>
<html>
    <head>
        <link rel="stylesheet" type="text/css" href="css/bootstrap.min.css" />        
    </head>    
    <body>
        <script type="text/javascript" src="javascript/peer.js"></script>
        <script type="text/javascript" src="javascript/video.js"></script>
        <script type="text/javascript" src="javascript/socket.js"></script>
        <script>
            window.addEventListener('load', function()
            {
                var peer = new Peer('', {
                    host: window.location.protocol+"//"+window.location.hostname, 
                    port: {{port}}, 
                    path: '/peer'
                });                
                
                peer.on('open', function() {
                    console.log("PeerJS connection success ID:", peer.id);
                });
                
                var socket = io.connect(window.location.protocol+"//"+window.location.hostname+":{{port}}/");
                socket.on('connect', function(err){
                    console.log("socket.onconnect callback");
                    if (err) {
                        console.log(err);
                    }
                    else {
                        console.log("Connected to socket.io");
                        // Register our id with the server
                        // or wait for id from server and then register
                        if (peer.open) {
                            socket.emit('registerId', {id: peer.id});        
                        }
                        else {
                            peer.on('open', function() {
                                console.log("Our peer id:", peer.id);
                            });    
                        }
                        console.log(peer)
                                                                    
                    }
                })
                
                var onCallConnected = function(stream) {
                    var video = document.getElementById('remote_video');
                    video.src = window.URL.createObjectURL(stream);
                };
                
                socket.on('nextStranger', function(stranger) {
                    console.log("Received nextStranger")
                    if (window.localMediaStream) {
                        var call = peer.call(stranger.id, window.localMediaStream); 
                        call.on('stream', onCallConnected);
                    }
                });
                
                peer.on('call', function(call) {
                    call.answer(window.localMediaStream);
                    call.on('stream', onCallConnected);
                });
                
                document.getElementById('nextButton').onclick = function(){
                    console.log("Sent req")
                    socket.emit('nextStranger');
                }
            });
        </script>
        <h1>Roulette</h1>
        
        <div class="row">
            <div class="col-md-6"> 
                <h3>Local Video</h3>
                <div class="container">
                    <video id="local_video" autoplay></video>
                    <h3>My ID: <span id="peer_id">/</span></h3>
                </div>
            </div>
            
            <div class="col-md-6"> 
                <h3>Remote Video</h3>
                <div>
                    <video id="remote_video" autoplay></video>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-6">
                <button class="btn-lg btn-primary center-block" onclick="toggleVideoPlayPause()">Stop</button>            
            </div>
            <div class="col-md-6">
                <button class="btn-lg btn-primary center-block" id="nextButton">NEXT</button>
            </div>    
        </div>
    </body>

</html>